#include <stdio.h>
#include <zmq.h>
#include <stdlib.h>
#include <string.h>
#include <unistd.h>
#include <assert.h>

int main( int argc, char * argv[] )
{
    void *context = zmq_ctx_new();
    void *publisher = zmq_socket(context, ZMQ_PUSH);
    void *subscriber = zmq_socket (context, ZMQ_SUB);

    ///Here we connect
    int rd = zmq_connect(publisher, "tcp://benternet.pxl-ea-ict.be:24041");
    int rc = zmq_connect( subscriber, "tcp://benternet.pxl-ea-ict.be:24042" );

    sleep (3);

    ///Here we filter tru
    const char *joinfilter = (argc > 1)? argv [1]: "BullsCows>join!>";
    const char *gamefilter = (argc > 1)? argv [1]: "BullsCows>game!>";

    ///Here we message tru

    const char *jointopic = (argc > 1)? argv [1]: "BullsCows>join?>";
    const char *gametopic = (argc > 1)? argv [1]: "BullsCows>game?>";

    /// in case if u want to char more
    char textplay [20];
    char textgame [20];
    char textjoin [20];

        char buf [256];
        buf[0] ='\0';
        zmq_msg_t message;

        strcpy(textjoin, jointopic); ///Bericht samenstellen
        strcat(textjoin, "join"); strcat(textgame, ">");
         rd = zmq_send(publisher, textjoin, strlen(textjoin), 0); printf("joined\n");
         memset(buf,0,256);
         rc = zmq_setsockopt (subscriber, ZMQ_SUBSCRIBE, joinfilter, strlen (joinfilter));
         rc = zmq_recv (subscriber, buf, 256, 0); assert(rc != -1);
         printf("Message received: %s\n\n",buf);
         memset(buf,0,256);
        rc = zmq_setsockopt (subscriber, ZMQ_SUBSCRIBE, gamefilter, strlen (gamefilter));
       do

        {

            rc = zmq_recv (subscriber, buf, 256, 0); assert(rc != -1);
            printf("Message received: %s\n\n",buf);
            memset(buf,0,256);
           /// rc = zmq_setsockopt (subscriber, ZMQ_SUBSCRIBE, joinfilter, strlen (joinfilter));
            char guess [100];
            scanf("%s",guess);

//                   zmq_msg_t message;
                     rc = zmq_msg_init (&message);
                    ///const char *guess  = "9998";


                    memset(buf,0,256);
                    ///printf("textueh");
                    memset(buf,0,256);
                    strcpy(textplay, gametopic); ///Bericht samenstellen
                    strcat(textplay, guess); strcat(textplay, ">");

                    //send and receive
                    rd = zmq_send(publisher, textplay, strlen(textplay), 0); printf("message send\n");
                    memset(buf,0,256);
        }while(50);
        rc = zmq_recv (subscriber, buf, 256, 0); assert(rc != -1);
        printf("Waiting for reply\n");
        memset(buf,0,256);



//        char *string = malloc (size + 1);
//        memcpy (string, zmq_msg_data (&message), size);

        sleep(1);



        zmq_msg_close(&message); ///Memory leak prevention
        zmq_close(publisher);
        zmq_close( subscriber );
        zmq_ctx_shutdown( context ); //optional for cleaning lady order (get ready you l*zy f*ck)
        zmq_ctx_term( context ); //cleaning lady goes to work
        printf("KTNXBYE!\n");
        return 0;
    }

